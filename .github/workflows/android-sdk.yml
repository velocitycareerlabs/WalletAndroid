name: WalletAndroid-SDK-Publish

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        type: choice
        options: [rc, prod]

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    env:
      PACKAGE_TYPE: aar
      JAVA_VERSION: 17
      ARTIFACT_PATH: VCL/build/outputs
      RELEASE_TAG: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Build AAR
        run: RELEASE_TAG=${{ env.RELEASE_TAG }} ./gradlew clean assemble${{ env.RELEASE_TAG }}

      - name: Build sources and javadoc jars
        run: ./gradlew sourcesJar javadocJar

      - name: List artifacts
        run: |
          ls -al ${{ env.ARTIFACT_PATH }}/${{ env.PACKAGE_TYPE }}/
          ls -al VCL/build/libs/

      - name: Validate artifacts
        run: |
          test -s ${{ env.ARTIFACT_PATH }}/${{ env.PACKAGE_TYPE }}/vcl-${{ env.RELEASE_TAG }}.aar || exit 1
          test -s VCL/build/libs/vcl-sources.jar || exit 1
          test -s VCL/build/libs/vcl-javadoc.jar || exit 1

      - name: üîç Check Gradle version output
        run: |
          RAW_VERSION=$(./gradlew -q printVersion)
          echo "Raw Gradle version: '$RAW_VERSION'"
          if [[ -z "$RAW_VERSION" ]]; then
            echo "‚ùå ERROR: Gradle version is empty. Check printVersion task."
            exit 1
          fi

      - name: Prepare JReleaser config
        run: |
          VERSION=$(./gradlew -q printVersion).${{ github.run_number }}
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          cp .github/jreleaser.template.yml .github/jreleaser.yml
          sed -i "s|{{RELEASE_VERSION}}|$VERSION|g" .github/jreleaser.yml
          sed -i "s|{{PRERELEASE}}|$([[ '${{ env.RELEASE_TAG }}' == 'rc' ]] && echo true || echo false)|" .github/jreleaser.yml
          sed -i "s|{{RELEASE_TAG}}|${{ env.RELEASE_TAG }}|g" .github/jreleaser.yml

      - name: üîß Sanitize GPG base64 secrets
        run: |
          echo "${{ secrets.MAVEN_CENTRAL_GPG_PRIVATE_KEY_B64 }}" | tr -d '\n' > cleaned_private.b64
          echo "${{ secrets.MAVEN_CENTRAL_GPG_PUBLIC_KEY_B64 }}" | tr -d '\n' > cleaned_public.b64
          echo "CLEANED_PRIVATE=$(cat cleaned_private.b64)" >> $GITHUB_ENV
          echo "CLEANED_PUBLIC=$(cat cleaned_public.b64)" >> $GITHUB_ENV

      - name: üß™ Inspect sanitized base64 inputs
        run: |
          echo "Cleaned PRIVATE length: ${#CLEANED_PRIVATE}"
          echo "Cleaned PUBLIC length: ${#CLEANED_PUBLIC}"
          echo "$CLEANED_PRIVATE" | base64 -d > /dev/null && echo "‚úÖ Private key decodes successfully" || echo "‚ùå Private key decode failed"
          echo "$CLEANED_PUBLIC" | base64 -d > /dev/null && echo "‚úÖ Public key decodes successfully" || echo "‚ùå Public key decode failed"
        env:
          CLEANED_PRIVATE: ${{ env.CLEANED_PRIVATE }}
          CLEANED_PUBLIC: ${{ env.CLEANED_PUBLIC }}

      - name: üöÄ Release with JReleaser
        uses: jreleaser/release-action@v2
        with:
          version: 1.18.0
          arguments: full-release -S -d -PprojectVersion=${{ env.RELEASE_VERSION }} -b . -c .github/jreleaser.yml
        env:
          JRELEASER_GPG_PASSPHRASE: ${{ secrets.MAVEN_CENTRAL_SIGNING_PASSWORD }}
          JRELEASER_GPG_PUBLIC_KEY: ${{ env.CLEANED_PUBLIC }}
          JRELEASER_GPG_SECRET_KEY: ${{ env.CLEANED_PRIVATE }}
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JRELEASER_TOKEN_USERNAME: ${{ secrets.MAVEN_CENTRAL_TOKEN_USERNAME }}
          JRELEASER_TOKEN_PASSWORD: ${{ secrets.MAVEN_CENTRAL_TOKEN_PASSWORD }}
          JRELEASER_NEXUS_STAGING_PROFILE_ID: ${{ secrets.ANDROID_NEXUS_STAGING_PROFILE_ID }}

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: vcl-${{ env.RELEASE_TAG }}-${{ github.run_number }}
          path: ${{ env.ARTIFACT_PATH }}/${{ env.PACKAGE_TYPE }}
          if-no-files-found: error
          retention-days: 14

      - name: ‚úÖ Notify success
        if: success()
        run: echo "‚úÖ Android SDK published successfully."

      - name: ‚ùå Notify failure
        if: failure()
        run: echo "‚ùå Android SDK build or release failed."
